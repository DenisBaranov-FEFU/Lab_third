# Первый этап: сборка приложения (builder stage)
# Используем официальный образ Go с Alpine Linux (легковесный)
# AS builder - даем имя этому этапу для использования в следующем
FROM golang:1.21-alpine AS builder

# Устанавливаем рабочую директорию внутри контейнера
# Все последующие команды будут выполняться в /app
WORKDIR /app

# Копируем файлы зависимостей Go в контейнер
# go.mod - список зависимостей
# go.sum - хэши зависимостей для безопасности
COPY go.mod go.sum ./

# Скачиваем и кэшируем зависимости Go
# Используется кэш Docker, чтобы не скачивать при каждом билде
RUN go mod download

# Копируем ВЕСЬ исходный код проекта в контейнер
# Включая все файлы и папки из текущей директории
COPY . .

# Компилируем Go приложение в статический бинарник
# CGO_ENABLED=0 - отключаем CGO для статической сборки
# GOOS=linux - собираем под Linux
# -o news-app - имя выходного файла
# ./cmd/server - точка входа (пакет main в cmd/server/)
RUN CGO_ENABLED=0 GOOS=linux go build -o news-app ./cmd/server

# Второй этап: финальный образ (production stage)
# Используем минимальный образ Alpine Linux
# Отделяем этап сборки от финального образа для уменьшения размера
FROM alpine:latest

# Устанавливаем CA сертификаты для HTTPS запросов
# --no-cache - не сохраняем кэш пакетов, уменьшаем размер образа
RUN apk --no-cache add ca-certificates

# Устанавливаем рабочую директорию для приложения
WORKDIR /root/

# Копируем скомпилированный бинарник из этапа builder
# COPY --from=builder - берем файл из предыдущего этапа
# /app/news-app - путь к бинарнику в образе builder
# . - текущая директория (в данном случае /root/)
COPY --from=builder /app/news-app .

# Информируем Docker о том, что контейнер слушает на порту 8080
# Это документация, не открывает порт автоматически!
EXPOSE 8080

# Команда запуска контейнера
# sh -c - выполняем команду через shell для подстановки переменных
# $(cat /run/secrets/db_password) - читаем пароль из Docker секрета
# Формат строки подключения к PostgreSQL:
# postgres://пользователь:пароль@хост:порт/база?параметры
# sslmode=disable - отключаем SSL для внутреннего общения в Docker сети
CMD ["sh", "-c", "./news-app -db postgres -conn \"postgres://postgres:$(cat /run/secrets/db_password)@db:5432/newsdb?sslmode=disable\""]