# Указываем версию формата docker-compose файла
version: "3.3"

# Раздел с определением сервисов (контейнеров)
services:
  # Сервис API (Go приложение)
  api:
    # Собираем образ из Dockerfile в текущей директории
    build: .
    # Имя контейнера (удобно для ручного управления)
    container_name: news_api
    # Зависимости: этот сервис зависит от сервиса db
    # Запустится только после запуска db
    depends_on:
      - db
    # Секреты, которые будут доступны контейнеру
    # Пароль БД монтируется в /run/secrets/db_password
    secrets:
      - db_password
    
  # Сервис базы данных PostgreSQL
  db:
    # Используем официальный образ PostgreSQL 15 версии
    image: postgres:15
    # Имя контейнера
    container_name: news_db
    # Переменные окружения для настройки PostgreSQL
    environment:
      # Имя пользователя по умолчанию
      POSTGRES_USER: postgres
      # Имя базы данных, которая будет создана при запуске
      POSTGRES_DB: newsdb
      # Файл с паролем (безопаснее чем переменная окружения)
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
    # Секреты для этого сервиса
    secrets:
      - db_password
    # Тома (volumes) для хранения данных
    volumes:
      # Именованный том для хранения данных БД
      # Сохраняет данные между перезапусками контейнеров
      - db_data:/var/lib/postgresql/data
    # Проверка здоровья PostgreSQL
    
  # Сервис Nginx для проксирования и HTTPS
  nginx:
    # Последняя версия официального образа Nginx
    image: nginx:latest
    # Имя контейнера
    container_name: news_nginx
    # Проброс портов с хоста на контейнер
    # Формат: "хост:контейнер"
    ports:
      # HTTPS на порту 8443 на хосте → порт 443 в контейнере
      - "8443:443"
      # HTTP на порту 8080 на хосте → порт 80 в контейнере
      - "8080:80"
    # Монтирование файлов конфигурации
    volumes:
      # Конфигурация Nginx (read-only)
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # SSL сертификаты для HTTPS (read-only)
      - ./certs:/etc/nginx/certs:ro
    # Зависимости: Nginx зависит от API
    # Запустится только после запуска api
    depends_on:
      - api

# Раздел определения томов (volumes)
volumes:
  # Именованный том для хранения данных PostgreSQL
  # Создается автоматически если не существует
  db_data:

# Раздел определения секретов
secrets:
  # Секрет с паролем от базы данных
  db_password:
    # Источник секрета - локальный файл
    # Содержимое будет доступно в /run/secrets/db_password внутри контейнеров
    file: ./secrets/db_password.txt